# GitHub Actions workflow for automatic deployment
name: ğŸš€ Deploy to Digital Ocean

on:
  push:
    branches:
      - main
      - be
  pull_request:
    branches:
      - main
      - be
  workflow_dispatch:

env:
  DEPLOY_PATH_MAIN: /root/skinalyze-be-v2
  DEPLOY_PATH_BE: /root/skinalyze-be-v2-staging
  BACKUP_SUFFIX: backup

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Set deployment path based on branch
        id: set_path
        run: |
          if [ "${{ github.ref_name }}" == "main" ]; then
            echo "deploy_path=${{ env.DEPLOY_PATH_MAIN }}" >> $GITHUB_OUTPUT
            echo "environment=Production" >> $GITHUB_OUTPUT
          else
            echo "deploy_path=${{ env.DEPLOY_PATH_BE }}" >> $GITHUB_OUTPUT
            echo "environment=Staging" >> $GITHUB_OUTPUT
          fi
          echo "start_time=$(TZ='Asia/Ho_Chi_Minh' date +'%Y-%m-%d %H:%M:%S UTC+7')" >> $GITHUB_OUTPUT

      - name: ğŸ”” Discord notification - Deployment started
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: ${{ job.status }}
          title: 'ğŸš€ Skinalyze Backend - Deployment Started'
          description: |
            **â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”**
            **ğŸ“¦ Repository:** Skinalyze Backend API
            **ğŸŒ Environment:** ${{ steps.set_path.outputs.environment }}
            **ğŸŒ¿ Branch:** `${{ github.ref_name }}`
            **ğŸ’¬ Commit:** ${{ github.event.head_commit.message }}
            **ğŸ‘¤ Triggered By:** ${{ github.actor }}
            **â±ï¸ Started At:** ${{ steps.set_path.outputs.start_time }}
            **ğŸ“ Deploy Path:** ${{ steps.set_path.outputs.deploy_path }}
            **â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”**
            âš¡ Deployment process initiated...
          color: 0xFFA500
          username: Rice Shower
          avatar_url: https://media.tenor.com/KwkJpyhCtYoAAAAM/uma-musume-uma-musume-pretty-derby.gif

      - name: ğŸ” Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DO_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.DO_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸ§ª Test SSH connection
        run: |
          ssh ${{ secrets.DO_USERNAME }}@${{ secrets.DO_HOST }} "echo 'âœ… SSH connection successful'"

      - name: ğŸ’¾ Backup current deployment
        id: backup
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          script_stop: false
          script: |
            DEPLOY_PATH="${{ steps.set_path.outputs.deploy_path }}"
            BACKUP_TAG="backup-$(date +%Y%m%d-%H%M%S)"

            echo "ğŸ“ Navigating to project directory..."
            cd $DEPLOY_PATH

            echo "ğŸ’¾ Creating backup tag for rollback..."
            git tag -f ${{ env.BACKUP_SUFFIX }} || true
            echo "backup_tag=${{ env.BACKUP_SUFFIX }}" >> $GITHUB_OUTPUT

            echo "ğŸ“¸ Saving current commit hash..."
            CURRENT_COMMIT=$(git rev-parse HEAD)
            echo "Current commit: $CURRENT_COMMIT"
            echo "$CURRENT_COMMIT" > .deployment-backup

            echo "ğŸ·ï¸ Tagging current Docker images..."
            docker tag skinalyze-app:latest skinalyze-app:$BACKUP_TAG || true

            echo "âœ… Backup complete: $BACKUP_TAG"

      - name: ğŸš€ Deploy to Digital Ocean (Blue-Green Strategy)
        id: deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          script_stop: true
          script: |
            DEPLOY_PATH="${{ steps.set_path.outputs.deploy_path }}"

            echo "ğŸ“ Navigating to project directory..."
            cd $DEPLOY_PATH

            echo "ğŸ” Checking current state..."
            git status

            echo "ğŸ“¥ Pulling latest code..."
            git fetch origin
            git clean -fd
            git reset --hard origin/${{ github.ref_name }}
            git pull origin ${{ github.ref_name }}

            echo "âœ… Code updated to commit:"
            CURRENT_COMMIT=$(git log -1 --oneline)
            echo "$CURRENT_COMMIT"

            echo "ğŸ” Checking Docker..."
            docker --version
            docker-compose --version

            echo "ğŸ”¨ Building new app image (no cache)..."
            docker-compose build --no-cache --pull app

            echo "ğŸ”„ Stopping old containers..."
            docker-compose down app

            echo "ğŸš€ Starting new containers..."
            docker-compose up -d app

            echo "â³ Waiting for services to stabilize..."
            sleep 20

            echo "ğŸ¥ Checking final service health..."
            docker-compose ps

            echo "ğŸ“‹ Showing recent logs..."
            docker-compose logs --tail=50 app

            echo "âœ… Deployment complete!"

      - name: ğŸ¥ Health Check
        id: health_check
        run: |
          echo "â³ Waiting for application to be ready..."
          sleep 30

          DEPLOY_PATH="${{ steps.set_path.outputs.deploy_path }}"

          # Health check with retry
          for i in {1..10}; do
            if ssh ${{ secrets.DO_USERNAME }}@${{ secrets.DO_HOST }} "curl -f -k https://api.nhatlonh.id.vn/api/v1 || curl -f http://localhost:3000/api/v1"; then
              echo "âœ… Health check passed!"
              echo "health_status=success" >> $GITHUB_OUTPUT
              exit 0
            fi
            echo "â³ Attempt $i/10 failed, retrying in 10s..."
            sleep 10
          done

          echo "âŒ Health check failed - initiating rollback..."
          ssh ${{ secrets.DO_USERNAME }}@${{ secrets.DO_HOST }} "cd $DEPLOY_PATH && docker-compose logs --tail=100 app"
          echo "health_status=failed" >> $GITHUB_OUTPUT
          exit 1

      - name: ğŸ”„ Rollback on Health Check Failure
        if: failure() && steps.health_check.outcome == 'failure'
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          script_stop: false
          script: |
            DEPLOY_PATH="${{ steps.set_path.outputs.deploy_path }}"

            echo "ğŸ”„ Starting rollback process..."
            cd $DEPLOY_PATH

            echo "ğŸ“‹ Reading backup commit..."
            if [ -f .deployment-backup ]; then
              BACKUP_COMMIT=$(cat .deployment-backup)
              echo "Found backup commit: $BACKUP_COMMIT"

              echo "âª Rolling back to previous commit..."
              git reset --hard $BACKUP_COMMIT

              echo "ğŸ”„ Stopping failed containers..."
              docker-compose down

              echo "ğŸ”¨ Rebuilding with backup code..."
              docker-compose build --no-cache app

              echo "ğŸš€ Starting backup version..."
              docker-compose up -d

              echo "â³ Waiting for rollback to complete..."
              sleep 20

              echo "ğŸ¥ Checking rollback health..."
              docker-compose ps
              docker-compose logs --tail=30 app

              echo "âœ… Rollback completed!"
            else
              echo "âš ï¸ No backup file found, manual intervention required!"
              exit 1
            fi

      - name: ğŸ“Š Get deployment info
        id: deployment_info
        if: always()
        run: |
          DEPLOY_TIME=$(TZ='Asia/Ho_Chi_Minh' date +'%Y-%m-%d %H:%M:%S UTC+7')
          echo "deploy_time=$DEPLOY_TIME" >> $GITHUB_OUTPUT

          DEPLOY_PATH="${{ steps.set_path.outputs.deploy_path }}"

          # Get container status
          CONTAINER_STATUS=$(ssh ${{ secrets.DO_USERNAME }}@${{ secrets.DO_HOST }} "cd $DEPLOY_PATH && docker-compose ps" || echo "Failed to get status")
          echo "Container Status:"
          echo "$CONTAINER_STATUS"

          # Check if rollback occurred
          if [ "${{ steps.health_check.outputs.health_status }}" == "failed" ]; then
            echo "rollback_occurred=true" >> $GITHUB_OUTPUT
          else
            echo "rollback_occurred=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ‰ Discord notification - Deployment succeeded
        uses: sarisia/actions-status-discord@v1
        if: success()
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: 'Success'
          content: 'âœ… <@&1385529547281403966> Deployment Succeeded!'

          title: 'âœ… Skinalyze Backend - Deployment Successful!'
          description: |
            **â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”**
            **ğŸ“¦ Repository:** Skinalyze Backend API
            **ğŸŒ Environment:** ${{ steps.set_path.outputs.environment }}
            **ğŸ“ Deploy Path:** ${{ steps.set_path.outputs.deploy_path }}
            **ğŸŒ¿ Branch:** `${{ github.ref_name }}`
            **ğŸ’¬ Commit:** ${{ github.event.head_commit.message }}
            **ğŸ‘¤ Deployed By:** ${{ github.actor }}
            **â±ï¸ Started At:** ${{ steps.set_path.outputs.start_time }}
            **â±ï¸ Completed At:** ${{ steps.deployment_info.outputs.deploy_time }}
            **ğŸ¥ Health Check:** âœ… Passed
            **ğŸ”„ Deployment Type:** Rolling Deployment
            **â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”**

            **ğŸ”— Quick Links:**
            â€¢ [View Commit](${{ github.event.head_commit.url }})
            â€¢ [API Documentation](https://skinalyze-be.nhatlonh.id.vn/api/docs)
            â€¢ [Health Check](https://skinalyze-be.nhatlonh.id.vn/health)
            â€¢ [View Workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ğŸ‰ **All services are running smoothly!**
          color: 0x00FF00
          username: Rice Shower
          avatar_url: https://media.tenor.com/KwkJpyhCtYoAAAAM/uma-musume-uma-musume-pretty-derby.gif

      - name: âŒ Discord notification - Deployment failed
        uses: sarisia/actions-status-discord@v1
        if: failure()
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: 'Failure'
          content: 'âš ï¸ <@&1385529547281403966> Deployment Failed!'

          title: 'âŒ Skinalyze Backend - Deployment Failed!'
          description: |
            **â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”**
            **ğŸ“¦ Repository:** Skinalyze Backend API
            **ğŸŒ Environment:** ${{ steps.set_path.outputs.environment }}
            **ğŸ“ Deploy Path:** ${{ steps.set_path.outputs.deploy_path }}
            **ğŸŒ¿ Branch:** `${{ github.ref_name }}`
            **ğŸ’¬ Commit:** ${{ github.event.head_commit.message }}
            **ğŸ‘¤ Triggered By:** ${{ github.actor }}
            **â±ï¸ Started At:** ${{ steps.set_path.outputs.start_time }}
            **â±ï¸ Failed At:** ${{ steps.deployment_info.outputs.deploy_time }}
            **âŒ Status:** Deployment or health check failed
            **ğŸ”„ Rollback:** ${{ steps.deployment_info.outputs.rollback_occurred == 'true' && 'âœ… Completed - Previous version restored' || 'âš ï¸ Not executed' }}
            **â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”**

            **ğŸ”— Troubleshooting Links:**
            â€¢ [View Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            â€¢ [View Error Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            â€¢ [View Commit](${{ github.event.head_commit.url }})

            ${{ steps.deployment_info.outputs.rollback_occurred == 'true' && 'âœ… **Automatic rollback completed. Service should be operational.**' || 'âš ï¸ **Please check the logs and fix the issue!**' }}

          color: 0xFF0000
          username: Rice Shower
          avatar_url: https://media.tenor.com/KwkJpyhCtYoAAAAM/uma-musume-uma-musume-pretty-derby.gif

      - name: ğŸ“ Get deployment logs
        if: failure()
        run: |
          DEPLOY_PATH="${{ steps.set_path.outputs.deploy_path }}"
          echo "Getting logs from failed deployment..."
          ssh ${{ secrets.DO_USERNAME }}@${{ secrets.DO_HOST }} "cd $DEPLOY_PATH && docker-compose logs --tail=100"
